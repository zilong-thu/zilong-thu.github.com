/*! project-loan 2014-09-21 */
function chart(a,b,c,d){function e(a){return a*k/d}function f(a){return l-a*l/(c*d*1.05)}var g=window.devicePixelRatio||1,h=14,i=document.getElementById("graph");if(i.width=i.width,i.setAttribute("class","canvas"),0!=arguments.length&&i.getContext){var j=i.getContext("2d"),k=i.width,l=i.height;j.moveTo(e(0),f(0)),j.lineTo(e(d),f(c*d)),j.lineTo(e(d),f(0)),j.closePath(),j.fillStyle="#f88",j.fill(),j.font="normal "+Math.ceil(h*g)+"px sans-serif",j.fillText("支付本息和",20*g,20*g);var m=0;j.beginPath(),j.moveTo(e(0),f(0));for(var n=1;d>=n;n++){var o=(a-m)*b;m+=c-o,j.lineTo(e(n),f(m))}j.lineTo(e(d),f(0)),j.closePath(),j.fillStyle="#7BA0B1",j.fill(),j.fillText("支付本金",20*g,40*g);var p=a;j.beginPath(),j.moveTo(e(0),f(p));for(var n=1;d>=n;n++){var o=p*b;p-=c-o,j.lineTo(e(n),f(p))}j.lineWidth=3*g,j.strokeStyle="#A6FF2E",j.stroke(),j.fillStyle="#A6FF2E",j.fillText("贷款尾款",20*g,60*g),j.fillStyle="black",j.textAlign="center";var q=f(0)*g;j.fillText("年份",20*g,q-5);for(var r=1;d>=12*r;r++){var s=e(12*r)*g;j.fillRect(s-.5,q-3,1,3),r%5==0&&12*r!==d&&j.fillText(String(r),s,q-5)}j.textAlign="right",j.textBaseline="middle";for(var t=[c*d,a],u=["#f88","#0047B3"],v=e(d),w=0;w<t.length;w++){var q=f(t[w]);j.fillStyle=u[w],j.fillRect(v-3,q-.5,3,1),j.fillText(String(t[w].toFixed(0)),v-10,q)}}}var Loan={amount:0,annualInterest:6.55,period:0,interestValues:[.7,.8,.85,.9,1,1.1,1.2,1.3],interestLabels:["最新基准利率7折","最新基准利率8折","最新基准利率8.5折","最新基准利率9折","最新基准利率","最新基准利率1.1倍","最新基准利率1.2倍","最新基准利率1.3倍"],selectInterest:1,periodLabels:["6个月","1年","2年","3年","4年","5年","10年","15年","20年","25年","30年"],periodValues:[.5,1,2,3,4,5,10,15,20,25,30],loanAmountMethod:"byLoanAmount",benchmarkRate:0,area:0,price:0,downPayment:0,canvas_DefaultWidth:400,calcBenchmarkRate:function(a){var b=6.55;return b=a>3?a>5?6.55:6.4:a>1?6.15:1==a?6:5.6,this.benchmarkRate=b,b},generateInterestList:function(){for(var a,b,c=document.getElementById("selectInterest"),d="",e=this.interestLabels,f=this.interestValues,g=0,h=e.length;h>g;g++)a=e[g],b=f[g],d+='<option value="'+b+'">'+a+"</option>";c.innerHTML=d},generatePeriodList:function(){for(var a,b,c=document.getElementById("select-period"),d="",e=this.periodLabels,f=this.periodValues,g=0,h=e.length;h>g;g++)a=e[g],b=f[g],d+='<option value="'+b+'">'+a+"</option>";c.innerHTML=d},saveInput:function(){if(window.localStorage){var a=this,b={amount:a.amount,period:a.period,selectInterest:a.selectInterest,annualInterest:a.annualInterest};localStorage.loanInput=JSON.stringify(b)}},getInput:function(){var a=document.getElementById("select-period"),b=document.getElementById("selectInterest"),c=document.getElementById("annual-interest");if(window.localStorage&&localStorage.loanInput){var d=JSON.parse(localStorage.loanInput);document.getElementById("amount").value=d.amount,a.value=d.period,Loan.calcBenchmarkRate(d.period),b.value=d.selectInterest,c.value=d.annualInterest}else a.value="20",b.value="1",c.value=Loan.calcBenchmarkRate(20)},adjustCanvas:function(){var a=document.getElementById("graph"),b=.92*window.innerWidth,c=.618*b,d=window.devicePixelRatio||1;640>b?(a.style.width=b+"px",a.style.height=c+"px",a.width=b*d,a.height=c*d):(a.style.width="640px",a.style.height="395.52px",a.width=640*d,a.height=395.52*d)}},EventUtil={getEvent:function(a){return a?a:window.event},getTarget:function(a){return a.target||a.srcElement},preventDefault:function(a){a.preventDefault?a.preventDefault():a.returnValue=!1},stopPropagation:function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0},addHandler:function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c}},Debug={getScreenSize:function(){var a=window.innerWidth,b=window.innerHeight,c=document.getElementById("debugDIV"),d=window.devicePixelRatio||1;c.innerHTML='<p><span class="title">浏览器视窗尺寸</span><br/>屏幕宽度：'+a+" px <br/>屏幕高度："+b+" px</p><p>屏幕的物理像素与视口像素之比（即window.devicePixelRatio） = "+d+"</p>"}};!function(){Loan.generateInterestList(),Loan.generatePeriodList();var a=document.getElementById("select-period"),b=document.getElementById("selectInterest"),c=document.getElementById("annual-interest"),d=document.getElementById("calc-button"),e=document.getElementById("amount");e.onchange=function(){Loan.amount=e.value},document.addEventListener("click",function(a){var a=EventUtil.getEvent(a),b=EventUtil.getTarget(a),c=b.parentNode,d=c.children;if("radio-group"===c.className){for(var e=0,f=d.length;f>e;e++)d[e].setAttribute("class","radio");b.setAttribute("class","radio radio-selected");var g=document.getElementById("by-houseArea");"user"===b.dataset.name?(g.setAttribute("style","display: none;"),Loan.loanAmountMethod="byLoanAmount"):(g.setAttribute("style",""),Loan.loanAmountMethod="byHouseArea")}},!1);var f=document.getElementById("house_area"),g=document.getElementById("house_price"),h=document.getElementById("downPayment"),i=document.getElementById("span_downPayment");EventUtil.addHandler(document,"change",function(a){a=EventUtil.getEvent(a);var b,c,d,j,k=EventUtil.getTarget(a);switch(k.id){case"house_area":case"house_price":case"downPayment":b=parseFloat(f.value)||0,c=parseFloat(g.value)||0,d=.01*parseFloat(h.value),j=(b*c).toFixed(2),document.getElementById("totalHousePrice").innerHTML='总房价： <span class="high-lite"> &yen;'+j+"</span>",Loan.amount=(j*(1-d)).toFixed(2),e.value=Loan.amount,i.innerHTML=" &yen;"+(j*d).toFixed(2);break;default:return}EventUtil.stopPropagation(a)}),a.onchange=function(a){var a=EventUtil.getEvent(a),d=EventUtil.getTarget(a).value;Loan.calcBenchmarkRate(d),Loan.period=d,c.value=(b.value*Loan.benchmarkRate).toFixed(2)},b.onchange=function(){var a=b.value;Loan.selectInterest=a,c.value=(a*Loan.benchmarkRate).toFixed(2)},d.onclick=function(){Loan.amount=parseFloat(e.value),Loan.annualInterest=parseFloat(c.value),Loan.period=parseFloat(a.value),Loan.selectInterest=b.value;var d=Loan.amount,f=Loan.annualInterest/100/12,g=12*Loan.period,h=Math.pow(1+f,g),i=(d*h*f/(h-1)).toFixed(2),j=(i*g-d).toFixed(2),k=(i*g).toFixed(2),l=document.getElementById("result"),m="";m+="<div>等额本息还款法：</div>",m+='<div><span class="label">每月还款</span> = <span class="high-lite">'+i+"</span> 元</div>",m+='<div><span class="label">支付总利息</span> = <span class="high-lite">'+j+"</span> 元</div>",m+='<div><span class="label">总还款额</span> = <span class="high-lite">'+k+"</span> 元</div>",l.innerHTML=m,Loan.saveInput(),chart(d,f,i,g)},window.onload=function(){Loan.getInput(),Loan.adjustCanvas(),Debug.getScreenSize()}}();